# https://taskfile.dev/installation/

# TODO: lint and ver tasks

version: '3'

vars:
  BINNAME: df2-server
  # serve configs
  SERVEPORT: 1323
  LOGREQUESTS: false
  NOROBOTS: false

tasks:
  default:
    desc: "Task runner for the Defacto2 server."
    cmds:
      - task --list-all
    silent: true
  lint:
    silent: false
    desc: runs the go formatter and lints the source code
    ignore_error: true
    cmds:
      - cmd: clear
        platforms: [linux,darwin]
      - cmd: gofumpt -w .
      - cmd: golangci-lint run
  build:
    desc: "Build the server binary."
    deps: [assets]
    cmds:
      - echo "Building..."
      - go build -o {{.BINNAME}} -v server.go
      - echo "Done!"
  build-race:
    desc: "Build the server binary  with race conditions."
    deps: [assets]
    cmds:
      - echo "Building with race conditions..."
      - go build -o {{.BINNAME}} -race -v server.go
      - echo "Done!"
  assets:
    desc: "Build and compress the CSS and JS assets."
    cmds:
      - echo "Building assets..."
      - go run runner/runner.go
      - echo "Done!"
  test:
    desc: "Run the test suite."
    cmds:
      - go test -v ./...
  tester:
    desc: "Run the slower test suite with race conditions."
    cmds:
      - go test -race -v ./...
  serve:
    desc: "Run the internal development server with live reload."
    cmds:
      - task: serve-air
      - task: serve-windows
  serve-prod:
    desc: "Run the internal development server with live reload."
    cmds:
      - task: serve-air
      - task: serve-windows-prod
  serve-air:
    internal: true
    platforms: [darwin, linux, freebsd] # other supported os can be added here
    env:
      DEFACTO2_PRODUCTION: false
      DEFACTO2_PORT: "{{.SERVEPORT}}"
      DEFACTO2_REQUESTS: "{{.LOGREQUESTS}}"
      DEFACTO2_NOROBOTS: "{{.NOROBOTS}}"
    cmds:
      - air
  serve-air-prod:
    internal: true
    platforms: [darwin, linux, freebsd] # other supported os can be added here
    env:
      DEFACTO2_PRODUCTION: true
      DEFACTO2_PORT: "{{.SERVEPORT}}"
      DEFACTO2_REQUESTS: "{{.LOGREQUESTS}}"
      DEFACTO2_NOROBOTS: "{{.NOROBOTS}}"
    cmds:
      - air
  serve-windows:
    internal: true
    platforms: [windows]
    env:
      DEFACTO2_PRODUCTION: false
      DEFACTO2_PORT: "{{.SERVEPORT}}"
      DEFACTO2_REQUESTS: "{{.LOGREQUESTS}}"
      DEFACTO2_NOROBOTS: "{{.NOROBOTS}}"
      DEFACTO2_THUMBNAILS: "F:\\Defacto2\\images400"
    cmds:
      - air -c .air.windows.toml 
  serve-windows-prod:
    internal: true
    platforms: [windows]
    env:
      DEFACTO2_PRODUCTION: true
      DEFACTO2_PORT: "{{.SERVEPORT}}"
      DEFACTO2_REQUESTS: "{{.LOGREQUESTS}}"
      DEFACTO2_NOROBOTS: "{{.NOROBOTS}}"
      DEFACTO2_THUMBNAILS: "F:\\Defacto2\\images400"
    cmds:
      - air -c .air.windows.toml 