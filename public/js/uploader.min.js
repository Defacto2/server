/* uploader.min.js Â© Defacto2 2024 */
(()=>{function o(e){let s=document.getElementById(e);if(s==null)throw new Error(`The ${e} element is null.`);return s}function l(e){if(`${e}`=="")return!0;let s=1980,t=new Date().getFullYear();return!(e<s||e>t)}function d(e){return`${e}`==""?!0:!(e<1||e>12)}function B(e){return`${e}`==""?!0:!(e<1||e>31)}function se(e,s){if(e=="")return!0;let t=Number(e),a=Number(s);if(!Number.isInteger(a)||a<1)throw new Error(`The ID sanity value is invalid: ${a}`);return Number.isInteger(t)&&t>0&&t<=a}function ae(e){let s=document.getElementById(e);if(s==null)throw new Error(`The ${e} element is null.`);s.addEventListener("click",function(){let t="Choose...",a=!0;ne(),I.value==""&&(I.classList.add(r),a=!1),(T.value==""||T.value==t)&&(T.classList.add(r),a=!1),(M.value==""||M.value==t)&&(M.classList.add(r),a=!1),S.value==""&&(S.classList.add(r),a=!1),z.value==""&&(z.classList.add(r),a=!1),l(Y.value)==!1&&(Y.classList.add(r),a=!1),d(F.value)==!1&&(F.classList.add(r),a=!1),B(R.value)==!1&&(R.classList.add(r),a=!1),a==!0&&oe.submit()})}var r="is-invalid",oe=document.getElementById("advancedUploader");oe.addEventListener("reset",ne);function ne(){I.classList.remove(r),T.classList.remove(r),M.classList.remove(r),S.classList.remove(r),z.classList.remove(r),Y.classList.remove(r),F.classList.remove(r),R.classList.remove(r)}var I=document.getElementById("advFile"),T=document.getElementById("advSelOS"),M=document.getElementById("advSelCat"),S=document.getElementById("advTitle"),z=document.getElementById("releasersAdv"),Y=document.getElementById("advYear"),F=document.getElementById("advMonth"),R=document.getElementById("advDay");var C=document.getElementById("imageFile"),D=document.getElementById("imageTitle"),H=document.getElementById("imageReleasers"),U=document.getElementById("imageYear"),A=document.getElementById("imageMonth"),re=document.getElementById("imageUploader"),c="is-invalid";function ie(){C.classList.remove(c),D.classList.remove(c),H.classList.remove(c),U.classList.remove(c),A.classList.remove(c)}re.addEventListener("reset",ie);function le(e){let s=document.getElementById(e);if(s==null)throw new Error(`The ${e} element is null.`);s.addEventListener("click",function(){let t=!0;ie(),C.value==""&&(C.classList.add(c),t=!1),D.value==""&&(D.classList.add(c),t=!1),H.value==""&&(H.classList.add(c),t=!1),l(U.value)==!1&&(U.classList.add(c),t=!1),d(A.value)==!1&&(A.classList.add(c),t=!1),t==!0&&re.submit()})}var Ee="application/x-freearc",we="application/octet-stream",Be="application/x-bzip",Te="application/x-bzip2",Me="application/gzip",$e="application/vnd.rar",ke="application/x-tar",Ie="application/zip",Se="application/x-7z-compressed";function ze(e){return[Ee,Be,Te,Me,$e,ke,Ie,Se].includes(e)!=!1}function Ye(e){return[we].includes(e)}function de(e){let s=!1;return s=Ye(e),!!(s||(s=ze(e),s))}function E(e){if(bootstrap===void 0)throw new Error("The bootstrap object is undefined.");let s=o(e);return new bootstrap.Modal(s,{keyboard:!0})}function $(e,s){let t=document.getElementById(s);if(t==null)throw new Error(`The ${s} element is null.`);let a=o(e);if(a.addEventListener("shown.bs.modal",function(){t.focus()}),bootstrap===void 0)throw new Error("The bootstrap object is undefined.");return new bootstrap.Modal(a,{keyboard:!0})}async function ce(e){try{let s=await Fe(e),t=await fetch(`/uploader/sha384/${s}`,{method:"PUT",headers:{"Content-Type":"text/plain"},body:s});if(!t.ok)throw new Error(`Hashing is not possible, server response: ${t.status}`);return await t.text()=="true"}catch(s){console.log(`Hashing is not possible: ${s}`)}}async function Fe(e){try{let s=await e.arrayBuffer(),t=await crypto.subtle.digest("SHA-384",s);return Array.from(new Uint8Array(t)).map(a=>a.toString(16).padStart(2,"0")).join("")}catch(s){throw new Error(`Could not use arrayBuffer or crypto.subtle: ${s}`)}}var j="uploader-intro-form",n="is-invalid",f="d-none",P=1024*1024,ue=100*P,Re=100,Ce=o(j),u=o("uploader-intro-alert"),w=o("uploader-intro-file"),De=o("uploader-intro-list-1"),He=o("uploader-intro-list-2"),p=o("uploader-intro-month"),L=o("uploader-intro-releaser-1"),y=o("uploader-intro-results"),v=o("uploader-intro-year"),h=o("uploader-intro-youtube");Ce.addEventListener("reset",ve);w.addEventListener("change",Ue);L.addEventListener("input",Pe);v.addEventListener("input",Ke);p.addEventListener("input",Ne);h.addEventListener("input",qe);function me(e){o(e).addEventListener("click",function(){let t=!0;if(L.value==""&&(L.classList.add(n),t=!1),l(v.value)==!1&&(v.classList.add(n),t=!1),d(p.value)==!1&&(p.classList.add(n),t=!1),p.value!=""&&v.value==""&&(v.classList.add(n),t=!1),w.value==""&&(w.classList.add(n),t=!1),t==!1){u.innerText="Please correct the problems with the form.",u.classList.remove(f);return}ve(),y.innerText="...",y.classList.remove(f)})}function fe(){htmx.on(`#${j}`,"htmx:xhr:progress",function(e){e.target.id==`${j}`&&htmx.find("#uploader-intro-progress").setAttribute("value",e.detail.loaded/e.detail.total*Re)})}async function Ue(){let e=this.files[0],s="";w.classList.remove(n),u.innerText="",u.classList.add(f);let t=[Ae(e),je(e)];if(t=t.filter(g=>g!=""),t.length>0){u.innerText=t.join(" "),u.classList.remove(f),this.value=s,this.classList.add(n),y.classList.remove(f);return}if(await ce(e)==!0){u.innerText=`The chosen file already exists in the database: ${e.name}`,u.classList.remove(f),this.value=s,this.classList.add(n),y.classList.remove(f);return}}function Ae(e){return e.size>ue?`The chosen file is too big at ${Math.round(e.size/P)}MB, maximum size is ${ue/P}MB.`:""}function je(e){return de(e.type)?"":`The chosen file mime type ${e.type} is probably not suitable for an intro.`}function ve(){De.innerHTML="",He.innerHTML="",y.innerHTML="",y.classList.add(f),u.innerText="",u.classList.add(f),v.classList.remove(n),p.classList.remove(n),L.classList.remove(n),h.classList.remove(n),w.classList.remove(n)}function Pe(){return L.value==""?(L.classList.add(n),!1):(L.classList.remove(n),!0)}function Ne(){return d(p.value)==!1?(p.classList.add(n),!1):(p.classList.remove(n),!0)}function Ke(){return l(v.value)==!1?(v.classList.add(n),!1):(v.classList.remove(n),!0)}function qe(){return h.value==""?(h.classList.remove(n),!0):new RegExp(/^[a-zA-Z0-9_-]{11}$/).test(h.value)==!1?(h.classList.add(n),!1):(h.classList.remove(n),!0)}var Ge=$("uploader-pouet-modal","pouet-submission"),Oe=$("uploader-demozoo-modal","demozoo-submission"),Xe=$("uploader-intro-modal","uploader-intro-file"),Ze=E("uploaderText"),_e=E("uploaderImg"),Je=E("uploaderMag"),Qe=E("uploaderAdv"),Ve="d",We="p",et="i",tt="n",st="g",at="m",ot="a";function pe(){document.addEventListener("keydown",function(e){if(!(!e.ctrlKey||!e.altKey))switch(e.key){case Ve:Oe.show();break;case We:Ge.show();break;case et:Xe.show();break;case tt:Ze.show();break;case st:_e.show();break;case at:Je.show();break;case ot:Qe.show();break}})}var N=document.getElementById("magFile"),K=document.getElementById("magTitle"),q=document.getElementById("magIssue"),G=document.getElementById("magYear"),O=document.getElementById("magMonth"),X=document.getElementById("magDay"),i="is-invalid";function nt(){N.classList.remove(i),K.classList.remove(i),q.classList.remove(i),G.classList.remove(i),O.classList.remove(i),X.classList.remove(i)}var rt=document.getElementById("magUploader");function he(e){let s=document.getElementById(e);if(s==null)throw new Error(`The ${e} element is null.`);s.addEventListener("click",function(){let t=!0;nt(),N.value==""&&(N.classList.add(i),t=!1),K.value==""&&(K.classList.add(i),t=!1),q.value==""&&(q.classList.add(i),t=!1),l(G.value)==!1&&(G.classList.add(i),t=!1),d(O.value)==!1&&(O.classList.add(i),t=!1),B(X.value)==!1&&(X.classList.add(i),t=!1),t==!0&&rt.submit()})}function Le(e,s){let t=document.getElementById(e);if(t==null)throw new Error(`The ${e} element is null.`);let a=document.getElementById(s);if(a==null)throw new Error(`The ${s} form element is null.`);a.addEventListener("reset",ge),t.addEventListener("click",function(){it()==!0&&a.submit()})}var Z=o("textFile"),_=o("textTitle"),J=o("textReleasers"),Q=o("textYear"),V=o("textMonth"),m="is-invalid";function ge(){Z.classList.remove(m),_.classList.remove(m),J.classList.remove(m),Q.classList.remove(m),V.classList.remove(m)}function it(){let e=!0;return ge(),Z.value==""&&(Z.classList.add(m),e=!1),_.value==""&&(_.classList.add(m),e=!1),J.value==""&&(J.classList.add(m),e=!1),l(Q.value)==!1&&(Q.classList.add(m),e=!1),d(V.value)==!1&&(V.classList.add(m),e=!1),e}var W="is-invalid",x="d-none";function ee(e,s){let t=o(e),a=o(`${e}-error`),g=o(`${e}-results`);o(`${e}-close`).addEventListener("click",te),o(`${e}-clear`).addEventListener("click",te);function te(){t.value="",t.focus(),t.classList.remove(W),a.innerText="",a.classList.add(x),g.innerHTML=""}let xe=45e4,be=2e5;switch(e){case"demozoo-submission":ye(t,xe);break;case"pouet-submission":ye(t,be);break}document.body.addEventListener("htmx:beforeRequest",function(){lt(a,g)}),document.body.addEventListener("htmx:afterRequest",function(b){if(b.detail.elt===null||b.detail.elt.id!==`${e}`)return;if(b.detail.successful)return dt(a);let k=b.detail.xhr;if(b.detail.failed&&k)return k.status===404?ct(a,g,s):mt(a,k);ut(a)})}function ye(e,s){e.addEventListener("input",function(){if(!se(e.value,s)){e.classList.add(W);return}e.classList.remove(W)})}function lt(e,s){s.innerHTML="",e.innerText="",e.classList.add(x)}function dt(e){e.classList.add(x),e.innerText=""}function ct(e,s,t){s.innerText=`Production not found on ${t}.`,e.classList.add(x),e.innerText=""}function ut(e){e.innerText="Something with the browser is not working, please refresh the page.",e.classList.remove(x)}function mt(e,s){e.innerText=`Something went wrong, ${s.status} status: ${s.responseText}.`,e.classList.remove(x)}(()=>{"use strict";pe(),ae("advSubmit"),le("imageSubmit"),me("uploader-intro-submit"),fe(),he("magSubmit"),Le("textSubmit","textUploader"),ee("demozoo-submission","Demozoo"),ee("pouet-submission","Pou\xEBt")})();})();
