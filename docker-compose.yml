version: '3'
#
# A placeholder container for the database migration and server.
# Intended for the domain test.defacto2.net.
#
# docker compose up --build
# docker compose up --detach
# docker compose run webapp --version
# docker compose run webapp address
# docker compose run webapp config
# docker compose exec webapp ls -l /root/.config
services:

  webapp:
    container_name: defacto2-webapp
    restart: unless-stopped
    env_file:
      - .env.local
    
    # build gets run using the --build flag or build command
    build:
      context: .      # use the current directory for the build context
                      # an inline dockerfile can be used instead of a Dockerfile
      dockerfile_inline: |
        FROM alpine:latest
        RUN mkdir /root/.config
        COPY dist/server_linux_amd64_v1/df2-server /usr/local/bin/df2-server
        EXPOSE 1323
        ENTRYPOINT ["df2-server"]

    ports:
      - "${D2_PORT}:1323"   # HTTP (unencrypted) port that the server listens on

    environment:
      # PS_HOST value must be kept as host.docker.internal 
      # otherwise the server will not be able to connect 
      # to the docker containerized postgresql database
      PS_HOST: "host.docker.internal"   
      # D2_PRODUCTION enables production mode to log errors and recover from any panics
      D2_PRODUCTION: "true"             
      # D2_DIR_[NAME] are internal directory volumes and must not be changed
      D2_DIR_DOWN: "/srv/downloads"
      D2_DIR_PREVIEW: "/srv/screenshots"
      D2_DIR_THUMB: "/srv/thumbnails"

    extra_hosts:
      - "host.docker.internal:host-gateway" # this is required for the server to connect
                                            # to the docker containerized postgresql database

    volumes:
      # store the server configuration and logs in a named volume
      # this will be kept and accessible even if the container is removed
      - webapp-config:/root/.config
      # the local directories located on the host are bound to the /opt directory in the container
      # EDIT the .env file to change the location of these directories
      - ${D2_DIR_DOWN}:/srv/downloads      # the directory where the server will store artifact downloads
      - ${D2_DIR_PREVIEW}:/srv/screenshots     # the directory where the server will store previews
      - ${D2_DIR_THUMB}:/srv/thumbnails    # the directory where the server will store thumbnails

volumes:
  webapp-config:

# other services to add?
# dns_search:
# domainname: test.defacto2.net