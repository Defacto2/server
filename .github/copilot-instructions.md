# Copilot Instructions for Defacto2 Server

## Project Overview

**Defacto2** is a self-contained web server written in Go that serves an archive of software history, demos, and artifacts from the scene. It's a full-stack application combining:
- Backend: Go web server using Echo framework
- Frontend: HTML/CSS/JavaScript templates with HTMX for interactivity
- Database: PostgreSQL (optional but required for full functionality)
- Asset Pipeline: Node.js-based asset compilation for CSS/JS

The server is configured entirely through environment variables and includes optional support for emulation, file downloads, and image previews.

## Build and Run Commands

### Using Task (Recommended)

This project uses [Task](https://taskfile.dev/) as the task runner. All commands are defined in `Taskfile.dist.yaml`.

**Common commands:**
```bash
task serve          # Run dev server with live reload (main command)
task serve-prod     # Run prod mode with live reload  
task test           # Run full test suite
task testr          # Run full test suite with race detection
task lint           # Format and lint all code
task binary         # Build standalone binary
```

**First time setup (REQUIRED):**
```bash
task _init          # Install dev tool dependencies (installs goreleaser, sqlboiler, etc.)
task ver            # Verify all tools are installed
```

**Other useful tasks:**
```bash
task assets         # Rebuild CSS/JS assets
task nil            # Run nil dereference static analysis
task spell          # Check markdown spelling in docs
task doc            # Browse package documentation at localhost:8090
task pkg-update     # Update all dependencies
task pkg-patch      # Patch dependencies to latest patch versions
task build-snapshot # Build release binaries
task serve-fix      # Run server with database fix flag
```

### Without Task

If Task is not available:
```bash
go run server.go                          # Run the server
go test -count 1 ./...                    # Run all tests
go test -count 1 -race ./...              # Run with race detection
go run -modfile=runner/go.mod runner/runner.go  # Rebuild assets
```

### Running Single Tests

Go test package paths are based on directory structure:
```bash
go test -count 1 ./handler/app                    # Test single package
go test -count 1 ./handler/app -run TestAppNew   # Run specific test
go test -count 1 -v ./handler/app                 # Verbose output
```

### Environment Configuration

The Taskfile can load environment variables from `init/.env.local` for local development:
```bash
# Copy template to local config
cp init/example.env.local init/.env.local

# Edit to set D2_DATABASE_URL, D2_PROD_MODE, etc.
nano init/.env.local
```

This allows running `task serve-dev` with custom paths for downloads, thumbnails, and database connection without modifying the system environment.

## Project Architecture

### High-Level Structure

```
server.go               # Entry point, sets up config, database, and router
├─ handler/            # HTTP route handlers (the "view" layer)
│  ├─ app/            # Main website routes (file records, artist pages, etc.)
│  ├─ html3/          # HTML/ASCII art text file rendering
│  ├─ download/       # File download endpoint
│  ├─ cache/          # Cache management handlers
│  ├─ sess/           # Session/authentication handlers
│  └─ [others]/       # Specialized handlers (demozoo, pouet, CSDB sync, etc.)
├─ model/             # Database models (generated by sqlboiler ORM)
├─ internal/          # Internal packages
│  ├─ command/        # CLI command logic (address, config, fix)
│  ├─ config/         # Environment variable parsing
│  ├─ postgres/       # Database initialization and migrations
│  ├─ logs/           # Structured logging setup (slog)
│  └─ [others]/       # Utilities (dir paths, tag parsing, panic recovery)
└─ runner/            # Separate Go module for asset build process
    └─ runner.go      # SCSS→CSS and JS minification/bundling
```

### Key Design Patterns

1. **Echo Framework Routes**: Handler functions follow Echo's signature pattern:
   ```go
   func (app *App) RouteName(c echo.Context) error
   ```
   Handlers parse requests, query the database, and render templates.

2. **SQLBoiler ORM**: Database models in `model/` are generated from the PostgreSQL schema. Raw SQL queries use the generated query builders.

3. **Template Rendering**: All HTML is rendered server-side using Go's `html/template` package. Templates are embedded in the binary.

4. **Embed FS**: Static files (CSS, JS, views) are embedded in the binary at compile time using `//go:embed` directives.

5. **Environment-Based Configuration**: No config files—all settings via `D2_*` environment variables parsed in `internal/config/`.

6. **Global Cache**: The `app.Cache` struct holds site-wide cached data (record counts, etc.) to avoid repeated database queries.

### Database Schema

The primary table is `files`, which stores metadata about scene artifacts. It has relationships to:
- Releasers and sceners (artists/groups)
- Platforms and file types
- File content hashes and locations

Database path must be provided via `D2_DATABASE_URL` environment variable. The `/init/` directory contains Postgres initialization scripts and the sqlboiler configuration.

### Asset Build Pipeline

Assets are processed separately via the `runner` module:
- **Input**: `assets/css/*.css` and `assets/js/*.js`
- **Process**: SCSS compilation, minification, bundling
- **Output**: Built files written to embedded filesystem
- **Trigger**: Runs before `binary` and `serve` tasks

The `runner.go` file orchestrates this process using Hugo and related Go tools.

## Key Conventions

### Code Organization

1. **Handler packages**: Each route handler is in its own subdirectory under `handler/`. Shared logic goes in `handler/app/internal/`.

2. **Model usage**: Import models from `github.com/Defacto2/server/model`. Use sqlboiler's query builders rather than raw SQL when possible. See `docs/patterns.md` for detailed SQLBoiler examples.

3. **Error handling**: Return errors from handlers; Echo middleware converts them to HTTP responses. Custom error types are defined in `handler/app/error.go`.

4. **Testing**: Test files live alongside code with `_test.go` suffix. Use `nalgeon/be` assertion library (see imports for examples).

5. **Template data**: Handlers populate a context struct and pass it to templates. Template helpers are methods on the `App` type in `handler/app/app.go`.

### Database

The application uses **PostgreSQL** (not MySQL) with [SQLBoiler](https://github.com/aarondl/sqlboiler) ORM for type-safe database queries. Key database setup:
- Connection via `D2_DATABASE_URL` environment variable (required for full functionality)
- Models auto-generated in `model/` from schema  
- Soft-delete support: `WithDeleted()` query mod includes deleted records
- See `docs/database.md` for troubleshooting and migration info from MySQL

#### Database Schema Overview

**Primary Table: `files`** (50+ columns)
The core table storing scene artifacts, releases, demos, and artwork. Auto-generated Go struct in `internal/postgres/models/files.go`.

**Key Columns:**
- **Identity**: `id` (primary key), `uuid` (global identifier)
- **Relationships**: `group_brand_for` (primary releaser), `group_brand_by` (secondary releaser)
- **Metadata**: `record_title`, `filename`, `filesize`, `platform`, `section` (category), `comment`
- **Dates**: `date_issued_year/month/day` (published), `createdat`, `updatedat`, `deletedat` (soft-delete), `deletedby`
- **Credits**: `credit_text`, `credit_program`, `credit_illustration`, `credit_audio` (comma-separated scener names)
- **External IDs**: `web_id_demozoo`, `web_id_pouet`, `web_id_16colors`, `web_id_github`, `web_id_youtube`
- **Archive Content**: `file_zip_content` (list of filenames in archive), `file_magic_type` (MIME type)
- **Integrity**: `file_integrity_strong` (SHA384 hash), `file_security_alert_url`
- **Emulation**: `dosee_run_program`, `dosee_hardware_cpu/graphic/audio`, `dosee_*` flags for DOS game configuration
- **Rendering**: `retrotxt_readme` (text file to display), `list_links`, `list_relations`

**Related Entities** (accessed through `files` columns):
- **Releasers/Groups**: Parsed from `group_brand_for` and `group_brand_by` fields. Use `model.Releaser` for querying distinct releasers and their stats.
- **Sceners**: Parsed from credit columns. Use `model.Scener` to query all files credited to a scener.

**Soft-Delete Pattern:**
- Deleted records have `deletedat` set to a timestamp and `deletedby` containing the UUID of who deleted it
- Queries exclude soft-deleted by default; include them with `qm.WithDeleted()`
- Epoch year for dates is 1980; year/month/day can be null for unknown dates

See `docs/patterns.md` for SQLBoiler query examples and `docs/database.md` for schema migration details.

### Error Types

Common errors defined in `handler/app/app.go`:
- `ErrValue`, `ErrNegative`, `ErrSession` - User input validation
- `ErrTmpl` - Template rendering failure
- `ErrCorrupt` - Cache data issues
- Use these or wrap with `fmt.Errorf()` for context

### Logging

Uses Go's structured logging (`slog`) initialized in `internal/logs/`. Log levels are configured via `D2_LOG_LEVEL` env var.

### Embedded Files

- Public web files: `//go:embed public/**/*` 
- View templates: `//go:embed view/**/*`
- Brand text: `//go:embed public/text/defacto2.txt`

Files are accessed via the embedded `FS` objects; ensure paths match the embed pattern.

### Naming Conventions

- **Handlers**: Method names match route purposes (e.g., `App.File`, `App.Artists`)
- **Templates**: Live in `view/` directory, organized by feature
- **Database queries**: Use `model` package functions (generated by sqlboiler)
- **Environment variables**: Prefixed with `D2_` (e.g., `D2_PROD_MODE`, `D2_DATABASE_URL`)

### Go Version

Current version: **Go 1.25.5**. See `docs/patterns.md` for modern Go 1.24+ patterns and idioms available for use.

## Important Dependencies

- **Echo** - Web framework and HTTP router
- **sqlboiler** - ORM code generator for type-safe database queries (requires running `task _init` to install)
- **PostgreSQL driver** (pgx) - Database connectivity
- **pnpm** - Package manager for Node.js dev dependencies (linting/formatting)
- **Task** - Task runner (use `task` command, not Make)
- **golangci-lint** - Linter aggregator (installed via `task _init`)
- **goreleaser** - Release automation (installed via `task _init`)
- **air** - Live reload tool for development (installed via `task _init`)

## Testing Notes

- Tests use the `be` assertion library (simple, zero-dependency testing)
- Many tests mock database calls to avoid requiring a live database
- Run with `-count 1` to disable test result caching (recommended for TDD)
- Use `-race` flag to detect concurrency issues in network code

## Common Tasks

| Task | Command |
|------|---------|
| Start dev server | `task serve` |
| Run all tests | `task test` |
| Run tests with race detection | `task testr` |
| Lint and format | `task lint` |
| Add Go dependency | `go get -u package.path` then `go mod tidy` |
| Add Node.js dev tool | `pnpm add -D package-name` |
| Generate new DB models | Edit schema, run `task _init` (installs sqlboiler) then regenerate |
| View API docs | `task doc` (opens localhost:8090) |
| Query database examples | See `docs/patterns.md` for SQLBoiler query patterns |

## Additional Resources

- **`docs/`** - Architecture and development guides
  - `patterns.md` - Go language patterns and SQLBoiler ORM examples
  - `database.md` - PostgreSQL setup, troubleshooting, and migration info
  - `source.md` - Source setup and Task runner details
- **`Taskfile.dist.yaml`** - Complete list of all available tasks with descriptions
- **`init/`** - Configuration templates, linting rules, and build config

